# Test that files are updated as expected.

# Start it up. Initial files should be created.
gopm -c gopmconfig --quit-delay 0 &
waitfile started.txt
cmpenv started.txt expect-started.txt
cmpenv foo/foo.txt expect-foo.txt
cmp bar.txt expect-bar.txt

# Reload the configuration. New files should be created,
# existing files should be updated, and files no longer
# present should be removed
cp config2.cue gopmconfig/config.cue
gopmctl --addr unix:gopm.socket reload
! exists foo/foo.txt
cmp bar.txt expect-bar-2.txt
cmp foo/baz/baz.txt expect-baz.txt

gopmctl --addr unix:gopm.socket shutdown
wait

-- gopmconfig/config.cue --
package config

config: grpc_server: {
	network: "unix"
	address: "gopm.socket"
}
config: programs: sleeper: {
	command: """
		echo started \(config.filesystem.foo.absPath) > started.txt

		"""
}

config: filesystem: {
	foo: {
		path: "foo/foo.txt"
		content: """
			something
			refer \(bar.absPath)

			"""
	}
	bar: {
		path: "bar.txt"
		content: """
			other thing

			"""
	}
}

-- config2.cue --
package config

config: grpc_server: {
	network: "unix"
	address: "gopm.socket"
}
config: programs: sleeper: {
	command: """
		echo started > started.txt

		"""
}
config: filesystem: {
	bar: {
		path: "bar.txt"
		content: """
			new bar content

			"""
	}
	baz: {
		path: "foo/baz/baz.txt"
		content: """
			baz content

			"""
	}
}

-- expect-started.txt --
started $WORK/foo/foo.txt
-- expect-foo.txt --
something
refer $WORK/bar.txt
-- expect-bar.txt --
other thing
-- expect-bar-2.txt --
new bar content
-- expect-baz.txt --
baz content
