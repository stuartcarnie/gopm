gopm -c gopmconfig --quit-delay 0 &
waitfile gopm.socket
waitfile finished.txt

gopmctl --addr unix:gopm.socket shutdown
wait
cmp stdout expect-stdout
-- gopmconfig/config.cue --
package config

config: grpc_server: {
	network: "unix"
	address: "gopm.socket"
}

config: programs: writer: {
	command: """
		# Note: sleep after each write so that the writes don't get
		# amalgamated in the pipe from the process.
		send() {
			echo "$@"
			sleep 0.1
		}
		sendNoNL() {
			echo -n "$@"
			sleep 0.1
		}
		send 'first line'
		sendNoNL 'second '
		send 'line'
		send 'third and
		fourth lines
		and fifth lines together'
		send done > finished.txt
		"""
	logfile: "/dev/stdout"
}
-- expect-stdout --
writer: first line
writer: second line
writer: third and
writer: fourth lines
writer: and fifth lines together
