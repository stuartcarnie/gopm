# Test that we can update the configuration to change
# the programs, and it stops and starts the processes as
# it should.

# Start it up.
mkdir progdir
gopm -c gopmconfig --quit-delay 0 &
waitfile progdir/started.txt

# Reload the original configuration.
# The process should remain uninterrupted.
gopmctl --addr unix:gopm.socket reload
! waitfile progdir/intr.txt

# Reload the configuration.
cp config2.cue gopmconfig/config.cue
gopmctl --addr unix:gopm.socket reload

# The original process should be interrupted and the
# new one started.
waitfile progdir/intr.txt
waitfile progdir/other-started.txt

gopmctl --addr unix:gopm.socket shutdown
wait

-- gopmconfig/config.cue --
package config

gopm: grpc_server: {
	network: "unix"
	address: "gopm.socket"
}
gopm: programs: sleeper: {
	command: "interrupt-notify started.txt intr.txt"
	directory: "progdir"
}

-- config2.cue --
package config

gopm: grpc_server: {
	network: "unix"
	address: "gopm.socket"
}
gopm: programs: other: {
	command: "echo hello > other-started.txt"
	directory: "progdir"
}
