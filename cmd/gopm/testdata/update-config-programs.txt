# Test that we can update the configuration to change
# the programs, and it stops and starts the processes as
# it should.

# Start it up.
mkdir progdir
gopm -c config1.yml --quit-delay 0 &
waitfile progdir/started.txt

# Reload the original configuration.
# The process should remain uninterrupted.
gopmctl --addr unix:gopm.socket reload
! waitfile progdir/intr.txt

# Reload the configuration.
cp config2.yml config1.yml
gopmctl --addr unix:gopm.socket reload

# The original process should be interrupted and the
# new one started.
waitfile progdir/intr.txt
waitfile progdir/other-started.txt

gopmctl --addr unix:gopm.socket shutdown
wait

-- config1.yml --
grpc_server:
    network: unix
    address: gopm.socket
programs:
    sleeper:
      name: sleeper
      command: |
        interrupt-notify started.txt intr.txt
      directory: progdir
      stop_signals: ["INT"]
      stop_as_group: true
      kill_as_group: true
      auto_start: true
      auto_restart: false
      stop_wait_seconds: 10s
      start_seconds: 1s

-- config2.yml --
grpc_server:
    network: unix
    address: gopm.socket
programs:
    other:
      name: other
      command: |
        echo hello > other-started.txt
      directory: progdir
      stop_signals: ["INT"]
      stop_as_group: true
      kill_as_group: true
      auto_start: true
      auto_restart: false
      stop_wait_seconds: 10s
      start_seconds: 1s
